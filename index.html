<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¦ã¨ã„ã£ã—ã‚‡</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100">
  <div id="app"></div>

  <script>
    // Firebaseè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyAqGO0-RnJAfQqsIunx35ZuAGc85cFD-lA",
      authDomain: "walking-36c5a.firebaseapp.com",
      projectId: "walking-36c5a",
      storageBucket: "walking-36c5a.firebasestorage.app",
      messagingSenderId: "457304106244",
      appId: "1:457304106244:web:3bcb8df4d4a3b27a971c51"
    };

    // FirebaseåˆæœŸåŒ–
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const { useState, useEffect, useRef } = React;

    function App() {
      const [activeTab, setActiveTab] = useState('record');
      const [isWalking, setIsWalking] = useState(false);
      const [currentWalk, setCurrentWalk] = useState(null);
      const [walks, setWalks] = useState([]);
      const [walkers, setWalkers] = useState([]);
      const [selectedWalkers, setSelectedWalkers] = useState([]);
      const [loading, setLoading] = useState(true);
      const [newWalkerName, setNewWalkerName] = useState('');
      const [showAddWalker, setShowAddWalker] = useState(false);
      const stationaryTimeRef = useRef(0);
      const lastPositionRef = useRef(null);

      // æ•£æ­©è€…ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
      useEffect(() => {
        const unsubscribe = db.collection('walkers').onSnapshot((snapshot) => {
          const walkerList = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          setWalkers(walkerList.sort((a, b) => a.order - b.order));
          setLoading(false);
        });
        return () => unsubscribe();
      }, []);

      // æ•£æ­©å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
      useEffect(() => {
        const unsubscribe = db.collection('walks')
          .orderBy('startTime', 'desc')
          .limit(50)
          .onSnapshot((snapshot) => {
            const walkList = snapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data(),
              startTime: doc.data().startTime?.toDate(),
              endTime: doc.data().endTime?.toDate()
            }));
            setWalks(walkList);
          });
        return () => unsubscribe();
      }, []);

      const toggleWalker = (walkerName) => {
        setSelectedWalkers(prev => {
          if (prev.includes(walkerName)) {
            return prev.filter(w => w !== walkerName);
          } else {
            if (prev.length >= 10) {
              alert('æ•£æ­©è€…ã¯æœ€å¤§10äººã¾ã§ã§ã™');
              return prev;
            }
            return [...prev, walkerName];
          }
        });
      };

      const addWalker = async () => {
        if (!newWalkerName.trim()) return;
        
        await db.collection('walkers').add({
          name: newWalkerName.trim(),
          order: walkers.length
        });
        
        setNewWalkerName('');
        setShowAddWalker(false);
      };

      const deleteWalker = async (walkerId) => {
        if (confirm('ã“ã®æ•£æ­©è€…ã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) {
          await db.collection('walkers').doc(walkerId).delete();
        }
      };

      const calculateDistance = (lat1, lng1, lat2, lng2) => {
        const R = 6371000; // åœ°çƒã®åŠå¾„(m)
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                 Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                 Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      };

      const calculateTotalDistance = (positions) => {
        if (positions.length < 2) return 0;
        
        let total = 0;
        for (let i = 1; i < positions.length; i++) {
          total += calculateDistance(
            positions[i-1].lat, positions[i-1].lng,
            positions[i].lat, positions[i].lng
          );
        }
        return total;
      };

      const startWalk = () => {
        if (selectedWalkers.length === 0) {
          alert('æ•£æ­©è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
          return;
        }
        
        if (!navigator.geolocation) {
          alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
          return;
        }

        const walk = {
          walkers: selectedWalkers,
          startTime: new Date(),
          positions: [],
          pee: false,
          poo: false,
          water: false,
          memo: ''
        };

        navigator.geolocation.getCurrentPosition(
          (position) => {
            walk.positions.push({
              lat: position.coords.latitude,
              lng: position.coords.longitude,
              time: new Date()
            });
            lastPositionRef.current = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
              time: Date.now()
            };
            stationaryTimeRef.current = 0;
            setCurrentWalk(walk);
            setIsWalking(true);
          },
          (error) => {
            alert('ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
          }
        );
      };

      useEffect(() => {
        if (!isWalking || !currentWalk) return;

        const interval = setInterval(() => {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const newPos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                time: new Date()
              };

              // å‰å›ã®ä½ç½®ã¨ã®è·é›¢ã‚’è¨ˆç®—
              if (lastPositionRef.current) {
                const distance = calculateDistance(
                  lastPositionRef.current.lat,
                  lastPositionRef.current.lng,
                  newPos.lat,
                  newPos.lng
                );

                // 10mä»¥å†…ãªã‚‰é™æ­¢æ™‚é–“ã‚’åŠ ç®—
                if (distance <= 10) {
                  stationaryTimeRef.current += 10; // 10ç§’é–“éš”ã§è¨ˆæ¸¬
                  
                  // 5åˆ†(300ç§’)ä»¥ä¸Šé™æ­¢ã—ã¦ã„ãŸã‚‰è‡ªå‹•çµ‚äº†
                  if (stationaryTimeRef.current >= 300) {
                    if (confirm('5åˆ†é–“ãã®å ´ã«ã¨ã©ã¾ã£ã¦ã„ã¾ã™ã€‚æ•£æ­©ã‚’çµ‚äº†ã—ã¾ã™ã‹?')) {
                      endWalk();
                    } else {
                      stationaryTimeRef.current = 0;
                    }
                  }
                } else {
                  // ç§»å‹•ã—ãŸã‚‰é™æ­¢æ™‚é–“ã‚’ãƒªã‚»ãƒƒãƒˆ
                  stationaryTimeRef.current = 0;
                }

                lastPositionRef.current = {
                  lat: newPos.lat,
                  lng: newPos.lng,
                  time: Date.now()
                };
              }

              setCurrentWalk(prev => ({
                ...prev,
                positions: [...prev.positions, newPos]
              }));
            }
          );
        }, 10000);

        return () => clearInterval(interval);
      }, [isWalking, currentWalk]);

      const endWalk = async () => {
        if (!currentWalk) return;
        
        const endTime = new Date();
        const duration = Math.floor((endTime - currentWalk.startTime) / 60000);
        const distance = calculateTotalDistance(currentWalk.positions);
        
        await db.collection('walks').add({
          walkers: currentWalk.walkers,
          startTime: firebase.firestore.Timestamp.fromDate(currentWalk.startTime),
          endTime: firebase.firestore.Timestamp.fromDate(endTime),
          duration,
          distance,
          pee: currentWalk.pee,
          poo: currentWalk.poo,
          water: currentWalk.water,
          memo: currentWalk.memo,
          positions: currentWalk.positions
        });
        
        setCurrentWalk(null);
        setIsWalking(false);
        setSelectedWalkers([]);
        stationaryTimeRef.current = 0;
        lastPositionRef.current = null;
      };

      const formatDate = (date) => {
        if (!date) return '';
        const d = new Date(date);
        return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
      };

      if (loading) {
        return React.createElement('div', { className: 'flex items-center justify-center min-h-screen' },
          React.createElement('div', { className: 'text-lg' }, 'èª­ã¿è¾¼ã¿ä¸­...')
        );
      }

      return React.createElement('div', { className: 'max-w-md mx-auto bg-white min-h-screen' },
        React.createElement('div', { className: 'bg-blue-500 text-white p-4' },
          React.createElement('h1', { className: 'text-xl font-bold' }, 'ğŸ• ç¦ã¨ã„ã£ã—ã‚‡')
        ),
        React.createElement('div', { className: 'flex border-b' },
          React.createElement('button', {
            onClick: () => setActiveTab('record'),
            className: `flex-1 py-3 ${activeTab === 'record' ? 'border-b-2 border-blue-500 text-blue-500' : 'text-gray-500'}`
          }, 'è¨˜éŒ²'),
          React.createElement('button', {
            onClick: () => setActiveTab('history'),
            className: `flex-1 py-3 ${activeTab === 'history' ? 'border-b-2 border-blue-500 text-blue-500' : 'text-gray-500'}`
          }, 'å±¥æ­´'),
          React.createElement('button', {
            onClick: () => setActiveTab('settings'),
            className: `flex-1 py-3 ${activeTab === 'settings' ? 'border-b-2 border-blue-500 text-blue-500' : 'text-gray-500'}`
          }, 'è¨­å®š')
        ),
        
        activeTab === 'record' && React.createElement('div', { className: 'p-4' },
          !isWalking ? React.createElement('div', { className: 'space-y-4' },
            React.createElement('div', null,
              React.createElement('label', { className: 'block text-sm font-medium mb-2' }, 'æ•£æ­©è€… (æœ€å¤§10äºº)'),
              React.createElement('div', { className: 'space-y-2' },
                walkers.map(w => React.createElement('label', { 
                  key: w.id, 
                  className: 'flex items-center p-2 border rounded cursor-pointer hover:bg-gray-50'
                },
                  React.createElement('input', {
                    type: 'checkbox',
                    checked: selectedWalkers.includes(w.name),
                    onChange: () => toggleWalker(w.name),
                    className: 'mr-2 w-5 h-5'
                  }),
                  React.createElement('span', null, w.name)
                ))
              ),
              selectedWalkers.length > 0 && React.createElement('p', { className: 'text-sm text-gray-600 mt-2' },
                'é¸æŠä¸­: ' + selectedWalkers.join(', ')
              )
            ),
            React.createElement('button', {
              onClick: startWalk,
              className: 'w-full bg-green-500 text-white py-4 rounded-lg text-lg font-bold'
            }, 'æ•£æ­©é–‹å§‹')
          ) : React.createElement('div', { className: 'space-y-4' },
            React.createElement('div', { className: 'bg-blue-50 p-4 rounded' },
              React.createElement('p', { className: 'text-sm text-gray-600' }, 'æ•£æ­©è€…: ' + currentWalk?.walkers.join(', ')),
              React.createElement('p', { className: 'text-sm text-gray-600' }, 'çµŒéæ™‚é–“: ' + Math.floor((new Date() - currentWalk?.startTime) / 60000) + 'åˆ†'),
              React.createElement('p', { className: 'text-sm text-gray-600' }, 'è·é›¢: ' + (calculateTotalDistance(currentWalk?.positions || []) / 1000).toFixed(2) + 'km')
            ),
            React.createElement('div', null,
              React.createElement('label', { className: 'block text-sm font-medium mb-2' }, 'è¨˜éŒ²'),
              React.createElement('div', { className: 'grid grid-cols-3 gap-2' },
                React.createElement('button', {
                  onClick: () => setCurrentWalk({...currentWalk, pee: !currentWalk.pee}),
                  className: `py-3 rounded border-2 ${currentWalk?.pee ? 'bg-yellow-100 border-yellow-500' : 'border-gray-300'}`
                }, 'ğŸ’§ ãŠã—ã£ã“'),
                React.createElement('button', {
                  onClick: () => setCurrentWalk({...currentWalk, poo: !currentWalk.poo}),
                  className: `py-3 rounded border-2 ${currentWalk?.poo ? 'bg-yellow-100 border-yellow-700' : 'border-gray-300'}`
                }, 'ğŸ’© ã†ã‚“ã¡'),
                React.createElement('button', {
                  onClick: () => setCurrentWalk({...currentWalk, water: !currentWalk.water}),
                  className: `py-3 rounded border-2 ${currentWalk?.water ? 'bg-blue-100 border-blue-500' : 'border-gray-300'}`
                }, 'ğŸ’§ æ°´')
              )
            ),
            React.createElement('div', null,
              React.createElement('label', { className: 'block text-sm font-medium mb-2' }, 'ãƒ¡ãƒ¢'),
              React.createElement('textarea', {
                value: currentWalk?.memo || '',
                onChange: (e) => setCurrentWalk({...currentWalk, memo: e.target.value}),
                className: 'w-full p-2 border rounded',
                rows: 3,
                placeholder: 'æ°—ã¥ã„ãŸã“ã¨ã‚’ãƒ¡ãƒ¢...'
              })
            ),
            React.createElement('button', {
              onClick: endWalk,
              className: 'w-full bg-red-500 text-white py-4 rounded-lg text-lg font-bold'
            }, 'æ•£æ­©çµ‚äº†')
          )
        ),
        
        activeTab === 'history' && React.createElement('div', { className: 'p-4' },
          walks.length === 0 ? React.createElement('p', { className: 'text-center text-gray-500 mt-8' }, 'ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“') :
          React.createElement('div', { className: 'space-y-3' },
            walks.map(walk => React.createElement('div', { key: walk.id, className: 'border rounded p-3 bg-white shadow-sm' },
              React.createElement('div', { className: 'flex justify-between items-start mb-2' },
                React.createElement('div', null,
                  React.createElement('p', { className: 'font-medium' }, Array.isArray(walk.walkers) ? walk.walkers.join(', ') : walk.walkers),
                  React.createElement('p', { className: 'text-sm text-gray-500' }, formatDate(walk.startTime))
                ),
                React.createElement('div', { className: 'text-right' },
                  React.createElement('p', { className: 'text-sm' }, walk.duration + 'åˆ†'),
                  React.createElement('p', { className: 'text-sm' }, (walk.distance / 1000).toFixed(2) + 'km')
                )
              ),
              React.createElement('div', { className: 'flex gap-2 text-sm' },
                walk.pee && React.createElement('span', null, 'ğŸ’§ãŠã—ã£ã“'),
                walk.poo && React.createElement('span', null, 'ğŸ’©ã†ã‚“ã¡'),
                walk.water && React.createElement('span', null, 'ğŸ’§æ°´')
              ),
              walk.memo && React.createElement('p', { className: 'text-sm text-gray-600 mt-2 border-t pt-2' }, walk.memo)
            ))
          )
        ),
        
        activeTab === 'settings' && React.createElement('div', { className: 'p-4' },
          React.createElement('h2', { className: 'text-lg font-bold mb-4' }, 'æ•£æ­©è€…ã®ç®¡ç†'),
          React.createElement('div', { className: 'space-y-2 mb-4' },
            walkers.map(w => React.createElement('div', { key: w.id, className: 'flex items-center justify-between p-2 border rounded' },
              React.createElement('span', null, w.name),
              React.createElement('button', {
                onClick: () => deleteWalker(w.id),
                className: 'text-red-500 text-sm'
              }, 'å‰Šé™¤')
            ))
          ),
          !showAddWalker ? React.createElement('button', {
            onClick: () => setShowAddWalker(true),
            className: 'w-full bg-blue-500 text-white py-2 rounded'
          }, '+ æ•£æ­©è€…ã‚’è¿½åŠ ') : React.createElement('div', { className: 'space-y-2' },
            React.createElement('input', {
              type: 'text',
              value: newWalkerName,
              onChange: (e) => setNewWalkerName(e.target.value),
              placeholder: 'åå‰ã‚’å…¥åŠ›',
              className: 'w-full p-2 border rounded'
            }),
            React.createElement('div', { className: 'flex gap-2' },
              React.createElement('button', {
                onClick: addWalker,
                className: 'flex-1 bg-green-500 text-white py-2 rounded'
              }, 'è¿½åŠ '),
              React.createElement('button', {
                onClick: () => {
                  setShowAddWalker(false);
                  setNewWalkerName('');
                },
                className: 'flex-1 bg-gray-300 py-2 rounded'
              }, 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«')
            )
          )
        )
      );
    }

    ReactDOM.render(React.createElement(App), document.getElementById('app'));
  </script>
</body>
</html>
