<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Á¶è„Å®„ÅÑ„Å£„Åó„Çá</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100">
  <div id="app"></div>

  <script>
    // FirebaseË®≠ÂÆö
    const firebaseConfig = {
      apiKey: "AIzaSyAqGO0-RnJAfQqsIunx35ZuAGc85cFD-lA",
      authDomain: "walking-36c5a.firebaseapp.com",
      projectId: "walking-36c5a",
      storageBucket: "walking-36c5a.firebasestorage.app",
      messagingSenderId: "457304106244",
      appId: "1:457304106244:web:3bcb8df4d4a3b27a971c51"
    };

    // FirebaseÂàùÊúüÂåñ
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const { useState, useEffect } = React;

    function App() {
      const [activeTab, setActiveTab] = useState('record');
      const [isWalking, setIsWalking] = useState(false);
      const [currentWalk, setCurrentWalk] = useState(null);
      const [walks, setWalks] = useState([]);
      const [walkers, setWalkers] = useState([]);
      const [selectedWalker, setSelectedWalker] = useState('');
      const [loading, setLoading] = useState(true);
      const [newWalkerName, setNewWalkerName] = useState('');
      const [showAddWalker, setShowAddWalker] = useState(false);

      // Êï£Ê≠©ËÄÖ„É™„Çπ„Éà„ÇíË™≠„ÅøËæº„Åø
      useEffect(() => {
        const unsubscribe = db.collection('walkers').onSnapshot((snapshot) => {
          const walkerList = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          setWalkers(walkerList.sort((a, b) => a.order - b.order));
          setLoading(false);
        });
        return () => unsubscribe();
      }, []);

      // Êï£Ê≠©Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø
      useEffect(() => {
        const unsubscribe = db.collection('walks')
          .orderBy('startTime', 'desc')
          .limit(50)
          .onSnapshot((snapshot) => {
            const walkList = snapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data(),
              startTime: doc.data().startTime?.toDate(),
              endTime: doc.data().endTime?.toDate()
            }));
            setWalks(walkList);
          });
        return () => unsubscribe();
      }, []);

      const addWalker = async () => {
        if (!newWalkerName.trim()) return;
        
        await db.collection('walkers').add({
          name: newWalkerName.trim(),
          order: walkers.length
        });
        
        setNewWalkerName('');
        setShowAddWalker(false);
      };

      const deleteWalker = async (walkerId) => {
        if (confirm('„Åì„ÅÆÊï£Ê≠©ËÄÖ„ÇíÂâäÈô§„Åó„Åæ„Åô„Åã?')) {
          await db.collection('walkers').doc(walkerId).delete();
        }
      };

      const startWalk = () => {
        if (!selectedWalker) {
          alert('Êï£Ê≠©ËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
          return;
        }
        
        if (!navigator.geolocation) {
          alert('„Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ‰ΩçÁΩÆÊÉÖÂ†±„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì');
          return;
        }

        const walk = {
          walker: selectedWalker,
          startTime: new Date(),
          positions: [],
          pee: false,
          poo: false,
          memo: ''
        };

        navigator.geolocation.getCurrentPosition(
          (position) => {
            walk.positions.push({
              lat: position.coords.latitude,
              lng: position.coords.longitude,
              time: new Date()
            });
            setCurrentWalk(walk);
            setIsWalking(true);
          },
          (error) => {
            alert('‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ‰ΩçÁΩÆÊÉÖÂ†±„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
          }
        );
      };

      useEffect(() => {
        if (!isWalking || !currentWalk) return;

        const interval = setInterval(() => {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              setCurrentWalk(prev => ({
                ...prev,
                positions: [...prev.positions, {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude,
                  time: new Date()
                }]
              }));
            }
          );
        }, 10000);

        return () => clearInterval(interval);
      }, [isWalking, currentWalk]);

      const calculateDistance = (positions) => {
        if (positions.length < 2) return 0;
        
        let total = 0;
        for (let i = 1; i < positions.length; i++) {
          const lat1 = positions[i-1].lat * Math.PI / 180;
          const lat2 = positions[i].lat * Math.PI / 180;
          const dLat = (positions[i].lat - positions[i-1].lat) * Math.PI / 180;
          const dLng = (positions[i].lng - positions[i-1].lng) * Math.PI / 180;
          
          const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                   Math.cos(lat1) * Math.cos(lat2) *
                   Math.sin(dLng/2) * Math.sin(dLng/2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
          total += 6371000 * c;
        }
        return total;
      };

      const endWalk = async () => {
        if (!currentWalk) return;
        
        const endTime = new Date();
        const duration = Math.floor((endTime - currentWalk.startTime) / 60000);
        const distance = calculateDistance(currentWalk.positions);
        
        await db.collection('walks').add({
          walker: currentWalk.walker,
          startTime: firebase.firestore.Timestamp.fromDate(currentWalk.startTime),
          endTime: firebase.firestore.Timestamp.fromDate(endTime),
          duration,
          distance,
          pee: currentWalk.pee,
          poo: currentWalk.poo,
          memo: currentWalk.memo,
          positions: currentWalk.positions
        });
        
        setCurrentWalk(null);
        setIsWalking(false);
        setSelectedWalker('');
      };

      const formatDate = (date) => {
        if (!date) return '';
        const d = new Date(date);
        return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
      };

      if (loading) {
        return React.createElement('div', { className: 'flex items-center justify-center min-h-screen' },
          React.createElement('div', { className: 'text-lg' }, 'Ë™≠„ÅøËæº„Åø‰∏≠...')
        );
      }

      return React.createElement('div', { className: 'max-w-md mx-auto bg-white min-h-screen' },
        React.createElement('div', { className: 'bg-blue-500 text-white p-4' },
          React.createElement('h1', { className: 'text-xl font-bold' }, 'üêï Á¶è„Å®„ÅÑ„Å£„Åó„Çá')
        ),
        React.createElement('div', { className: 'flex border-b' },
          React.createElement('button', {
            onClick: () => setActiveTab('record'),
            className: `flex-1 py-3 ${activeTab === 'record' ? 'border-b-2 border-blue-500 text-blue-500' : 'text-gray-500'}`
          }, 'Ë®òÈå≤'),
          React.createElement('button', {
            onClick: () => setActiveTab('history'),
            className: `flex-1 py-3 ${activeTab === 'history' ? 'border-b-2 border-blue-500 text-blue-500' : 'text-gray-500'}`
          }, 'Â±•Ê≠¥'),
          React.createElement('button', {
            onClick: () => setActiveTab('settings'),
            className: `flex-1 py-3 ${activeTab === 'settings' ? 'border-b-2 border-blue-500 text-blue-500' : 'text-gray-500'}`
          }, 'Ë®≠ÂÆö')
        ),
        
        activeTab === 'record' && React.createElement('div', { className: 'p-4' },
          !isWalking ? React.createElement('div', { className: 'space-y-4' },
            React.createElement('div', null,
              React.createElement('label', { className: 'block text-sm font-medium mb-2' }, 'Êï£Ê≠©ËÄÖ'),
              React.createElement('select', {
                value: selectedWalker,
                onChange: (e) => setSelectedWalker(e.target.value),
                className: 'w-full p-2 border rounded'
              },
                React.createElement('option', { value: '' }, 'ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'),
                walkers.map(w => React.createElement('option', { key: w.id, value: w.name }, w.name))
              )
            ),
            React.createElement('button', {
              onClick: startWalk,
              className: 'w-full bg-green-500 text-white py-4 rounded-lg text-lg font-bold'
            }, 'Êï£Ê≠©ÈñãÂßã')
          ) : React.createElement('div', { className: 'space-y-4' },
            React.createElement('div', { className: 'bg-blue-50 p-4 rounded' },
              React.createElement('p', { className: 'text-sm text-gray-600' }, 'Êï£Ê≠©ËÄÖ: ' + currentWalk?.walker),
              React.createElement('p', { className: 'text-sm text-gray-600' }, 'ÁµåÈÅéÊôÇÈñì: ' + Math.floor((new Date() - currentWalk?.startTime) / 60000) + 'ÂàÜ'),
              React.createElement('p', { className: 'text-sm text-gray-600' }, 'Ë∑ùÈõ¢: ' + (calculateDistance(currentWalk?.positions || []) / 1000).toFixed(2) + 'km')
            ),
            React.createElement('div', null,
              React.createElement('label', { className: 'block text-sm font-medium mb-2' }, 'ÊéíÊ≥Ñ'),
              React.createElement('div', { className: 'flex gap-2' },
                React.createElement('button', {
                  onClick: () => setCurrentWalk({...currentWalk, pee: !currentWalk.pee}),
                  className: `flex-1 py-3 rounded border-2 ${currentWalk?.pee ? 'bg-yellow-100 border-yellow-500' : 'border-gray-300'}`
                }, 'üíß „Åä„Åó„Å£„Åì'),
                React.createElement('button', {
                  onClick: () => setCurrentWalk({...currentWalk, poo: !currentWalk.poo}),
                  className: `flex-1 py-3 rounded border-2 ${currentWalk?.poo ? 'bg-yellow-100 border-yellow-700' : 'border-gray-300'}`
                }, 'üí© „ÅÜ„Çì„Å°')
              )
            ),
            React.createElement('div', null,
              React.createElement('label', { className: 'block text-sm font-medium mb-2' }, '„É°„É¢'),
              React.createElement('textarea', {
                value: currentWalk?.memo || '',
                onChange: (e) => setCurrentWalk({...currentWalk, memo: e.target.value}),
                className: 'w-full p-2 border rounded',
                rows: 3,
                placeholder: 'Ê∞ó„Å•„ÅÑ„Åü„Åì„Å®„Çí„É°„É¢...'
              })
            ),
            React.createElement('button', {
              onClick: endWalk,
              className: 'w-full bg-red-500 text-white py-4 rounded-lg text-lg font-bold'
            }, 'Êï£Ê≠©ÁµÇ‰∫Ü')
          )
        ),
        
        activeTab === 'history' && React.createElement('div', { className: 'p-4' },
          walks.length === 0 ? React.createElement('p', { className: 'text-center text-gray-500 mt-8' }, '„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì') :
          React.createElement('div', { className: 'space-y-3' },
            walks.map(walk => React.createElement('div', { key: walk.id, className: 'border rounded p-3 bg-white shadow-sm' },
              React.createElement('div', { className: 'flex justify-between items-start mb-2' },
                React.createElement('div', null,
                  React.createElement('p', { className: 'font-medium' }, walk.walker),
                  React.createElement('p', { className: 'text-sm text-gray-500' }, formatDate(walk.startTime))
                ),
                React.createElement('div', { className: 'text-right' },
                  React.createElement('p', { className: 'text-sm' }, walk.duration + 'ÂàÜ'),
                  React.createElement('p', { className: 'text-sm' }, (walk.distance / 1000).toFixed(2) + 'km')
                )
              ),
              React.createElement('div', { className: 'flex gap-2 text-sm' },
                walk.pee && React.createElement('span', null, 'üíß'),
                walk.poo && React.createElement('span', null, 'üí©')
              ),
              walk.memo && React.createElement('p', { className: 'text-sm text-gray-600 mt-2 border-t pt-2' }, walk.memo)
            ))
          )
        ),
        
        activeTab === 'settings' && React.createElement('div', { className: 'p-4' },
          React.createElement('h2', { className: 'text-lg font-bold mb-4' }, 'Êï£Ê≠©ËÄÖ„ÅÆÁÆ°ÁêÜ'),
          React.createElement('div', { className: 'space-y-2 mb-4' },
            walkers.map(w => React.createElement('div', { key: w.id, className: 'flex items-center justify-between p-2 border rounded' },
              React.createElement('span', null, w.name),
              React.createElement('button', {
                onClick: () => deleteWalker(w.id),
                className: 'text-red-500 text-sm'
              }, 'ÂâäÈô§')
            ))
          ),
          !showAddWalker ? React.createElement('button', {
            onClick: () => setShowAddWalker(true),
            className: 'w-full bg-blue-500 text-white py-2 rounded'
          }, '+ Êï£Ê≠©ËÄÖ„ÇíËøΩÂä†') : React.createElement('div', { className: 'space-y-2' },
            React.createElement('input', {
              type: 'text',
              value: newWalkerName,
              onChange: (e) => setNewWalkerName(e.target.value),
              placeholder: 'ÂêçÂâç„ÇíÂÖ•Âäõ',
              className: 'w-full p-2 border rounded'
            }),
            React.createElement('div', { className: 'flex gap-2' },
              React.createElement('button', {
                onClick: addWalker,
                className: 'flex-1 bg-green-500 text-white py-2 rounded'
              }, 'ËøΩÂä†'),
              React.createElement('button', {
                onClick: () => {
                  setShowAddWalker(false);
                  setNewWalkerName('');
                },
                className: 'flex-1 bg-gray-300 py-2 rounded'
              }, '„Ç≠„É£„É≥„Çª„É´')
            )
          )
        )
      );
    }

    ReactDOM.render(React.createElement(App), document.getElementById('app'));
  </script>
</body>
</html>

